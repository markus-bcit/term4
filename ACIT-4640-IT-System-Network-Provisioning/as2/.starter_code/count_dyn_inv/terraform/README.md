# Terraform Count Demonstration

## Description

This terraform configuration creates a VPC with a public subnet in each
availability zone, a single route table, a single internet gateway, and a single
security group. The VPC is created with a CIDR block specified in the `vpc_cidr`
input variable and must have a /16 network address. Availability zones that
don't support the preferred EC2 instance type are skipped and no subnet is
created in them.

Attached to each subnet are EC2 instances. An EC2 instance is created for each
role in the `server_roles` list. The subnets are assigned addresses from the VPC
CIDR, each receiving a /24 network address.

The EC2 instances are created:

- using the first or preferred instance type in the `instance_types` list
- with a single security group that allows access as specified in the
  `security_group` input variable
- with an SSH key pair that is generated by the `ssh_key` module.
- with the most recent Ubuntu 23.04 AMI available

It also creates a local file for use by Ansible that specifies the ssh private
key file for connecting to the EC2 instances.

<!-- BEGIN_TF_DOCS -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.3.0)

- <a name="requirement_aws"></a> [aws](#requirement\_aws) (~> 4.16)

- <a name="requirement_local"></a> [local](#requirement\_local) (~> 2.1)

## Providers

The following providers are used by this module:

- <a name="provider_aws"></a> [aws](#provider\_aws) (4.67.0)

- <a name="provider_local"></a> [local](#provider\_local) (2.5.1)

## Modules

The following Modules are called:

### <a name="module_ssh_key"></a> [ssh\_key](#module\_ssh\_key)

Source: ./modules/aws_ssh_key_pair

Version:

## Resources

The following resources are used by this module:

- [aws_instance.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance) (resource)
- [aws_internet_gateway.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/internet_gateway) (resource)
- [aws_route_table.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route_table) (resource)
- [aws_route_table_association.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route_table_association) (resource)
- [aws_security_group.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) (resource)
- [aws_subnet.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/subnet) (resource)
- [aws_vpc.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc) (resource)
- [aws_vpc_security_group_egress_rule.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_egress_rule) (resource)
- [aws_vpc_security_group_ingress_rule.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_ingress_rule) (resource)
- [local_file.all_vars](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file) (resource)
- [aws_ami.ubuntu](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) (data source)
- [aws_availability_zones.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/availability_zones) (data source)
- [aws_ec2_instance_type_offering.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offering) (data source)

## Required Inputs

The following input variables are required:

### <a name="input_home_net"></a> [home\_net](#input\_home\_net)

Description: Home network, written in CIDR notation

Type: `string`

### <a name="input_project_name"></a> [project\_name](#input\_project\_name)

Description: Project name

Type: `string`

### <a name="input_security_group"></a> [security\_group](#input\_security\_group)

Description: configuration for security group

Type:

```hcl
object({
    name        = string
    description = string
    egress_rules = list(object(
      {
        description = string
        ip_protocol = string
        from_port   = number
        to_port     = number
        cidr_ipv4   = string
        rule_name   = string
      }
    ))
    ingress_rules = list(object(
      {
        description = string
        ip_protocol = string
        from_port   = number
        to_port     = number
        cidr_ipv4   = string
        rule_name   = string
      }
    ))
  })
```

### <a name="input_server_roles"></a> [server\_roles](#input\_server\_roles)

Description: A list of the ec2 instance "roles" to create, this must match the ansible groups

Type: `list(string)`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_aws_region"></a> [aws\_region](#input\_aws\_region)

Description: AWS region

Type: `string`

Default: `"us-west-2"`

### <a name="input_bcit_net"></a> [bcit\_net](#input\_bcit\_net)

Description: BCIT network, written in CIDR notation

Type: `string`

Default: `"142.232.0.0/16"`

### <a name="input_default_route"></a> [default\_route](#input\_default\_route)

Description: Default route

Type: `string`

Default: `"0.0.0.0/0"`

### <a name="input_instance_types"></a> [instance\_types](#input\_instance\_types)

Description: A list of type of EC2 instance types ordered by preference

Type: `list(string)`

Default:

```json
[
  "t2.micro",
  "t3.micro"
]
```

### <a name="input_ssh_key_name"></a> [ssh\_key\_name](#input\_ssh\_key\_name)

Description: AWS SSH key name

Type: `string`

Default: `"acit_4640_202330"`

### <a name="input_vpc_cidr"></a> [vpc\_cidr](#input\_vpc\_cidr)

Description: VPC CIDR written in CIDR notation, must have a 16 bit netmask

Type: `string`

Default: `"192.168.0.0/16"`

## Outputs

The following outputs are exported:

### <a name="output_ec2_instances"></a> [ec2\_instances](#output\_ec2\_instances)

Description: Name indexed Map of EC2 instance information that includes id, public IP, private IP, DNS name, and availability zone

### <a name="output_gateway"></a> [gateway](#output\_gateway)

Description: Gateway information including id and name

### <a name="output_route_table"></a> [route\_table](#output\_route\_table)

Description: Route table information including id and name

### <a name="output_security_group"></a> [security\_group](#output\_security\_group)

Description: Security group information including id and name

### <a name="output_ssh_priv_key_file"></a> [ssh\_priv\_key\_file](#output\_ssh\_priv\_key\_file)

Description: Absolute path to the private key file

### <a name="output_ssh_pub_key_file"></a> [ssh\_pub\_key\_file](#output\_ssh\_pub\_key\_file)

Description: Absolute path to the public key file

### <a name="output_subnets"></a> [subnets](#output\_subnets)

Description: A name indexed map of subnet information including id, CIDR, and availability zone

### <a name="output_vpc"></a> [vpc](#output\_vpc)

Description: VPC information including id, name, and CIDR
<!-- END_TF_DOCS -->
